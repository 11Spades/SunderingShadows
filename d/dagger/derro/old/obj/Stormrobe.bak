#include <std.h>

inherit PARMOUR;

object ARMO;
string OWNER;
void init(){
    ::init();
    if(interactive(TP) && TP==environment(TO)  && !OWNER) OWNER = TPQN;
}
void create(){
    ::create();
    set_heart_beat(1);
    set_name("stormrobes");
   set_id(({"robe","robes","stormrobe","stormrobes","chain draped stormrobes"}));
    set_short(
       "%^RESET%^%^CYAN%^Chain draped stormrobes%^RESET%^"
    );
    set_long(
      "%^CYAN%^"
   "The material these robes are made of looks torn and rent by the winds which "
   "eternally whip at them.  Even in a calm environment the robes flap as if its "
      "being driven in a gale.   Blackened chains seem to hold the material "
      "together and to anchor it to its wearer."
    );
    set_ac(2);
    set_weight(4);
    set_value(1500);
    set_property("enchantment",1);
    set_type("clothing");
    set_limbs(({"torso"}));
    set_max_internal_encumbrance(21);
    set_wear((:TO,"wear_it":));
    set_remove((:TO,"remove_it":));
    set_struck((:TO,"struck":));
}
int query_size(){
    if(living(ETO))return ETO->query_size();
    else return 3;
}
int wear_it(){
    if(((TP->is_class("mage"))||(TP->is_class("cleric"))) && ((!TP->is_class("fighter")) && (!TP->is_class("thief")))){
	if((int)ETO->query_highest_level() <20){
	    tell_object(ETO,"The robe laughs at the puny one who tries to wear it.");
	    tell_room(environment(ETO),""+ETO->query_cap_name()+"s robe seems to mock him with a rustling of wind through its folds.",ETO);
	    return 0;
	}
	if((string)TP->query_name() !=OWNER){
  tell_room(ETP,"%^BOLD%^%^YELLOW%^A bolt of lightning strikes the person who dares to wear a stormrobe that is not attuned to "+ETO->query_objective()+"!");
	    TP->do_damage("torso",(random(50)+10));
	    return 0;
	}
  say("%^CYAN%^"+TPQCN+" wraps blackened chains around the tattered windripped robe to keep it in place.");
   say("%^BOLD%^%^YELLOW%^Lightning dances across the chains as "+TPQCN+" wears the stormrobes.");
   write("%^BOLD%^%^YELLOW%^Lightning dances across the chains as you wear the robes.");
	TP->set_property("magic resistance",35);
	TP->add_sight_bonus(5);
	set_heart_beat(1);
	return 1;
    }
    write("%^CYAN%^Bah this robe looks old and tattered, you decide against wearing it!");
  say("%^CYAN%^"+ETO->query_cap_name()+" looks at some robes in "+ETO->query_possessive()+" hands and scoffs at them.");
    return 0;
}
int remove_it(){
    write("%^RESET%^%^CYAN%^The stormwinds around you calm as you remove the robe.");
   tell_room(environment(ETO),"%^RESET%^%^CYAN%^The robes of storm stop blowing in their own wind as "+ETO->query_cap_name()+" removes them.",ETO);
    ETO->add_sight_bonus(-5);
    ETO->set_property("magic resistance",-35);
    return 1;
}
int struck(int damage, object what, object who){
    //if(objectp(what)){
    //tell_object(ETO,"%^RESET%^%^CYAN%^Stormwinds blast at "+what->query_name()+" as he hits you weaking his blow!");
    //}else{
  if(!(random(2))){
      tell_room(environment(query_worn()),"%^RESET%^%^CYAN%^"+ETO->query_cap_name()+"s robes suddenly snap in their own wind and their flapping knocks "+who->query_cap_name()+"'s blow off balance!",({who,ETO}));
      tell_object(who,"%^RESET%^%^CYAN%^As you try to hit "+ETO->query_cap_name()+" a flapping chain from "+ETO->query_possessive()+ " robes knocks you off balance making your blow less effective!.");
    if(!random(4)){
  tell_room(environment(ETO),"%^BOLD%^%^YELLOW%^A great arc crackles from the chains at "+who->query_cap_name()+" as "+who->query_objective()+" touches them!",who);
    tell_object(who,"%^BOLD%^%^YELLOW%^A great arc of lightning hits you as the chain strikes!");
    who->do_damage("torso",random(15)+15);
      }
  return (damage*(1/2));
  }
  return 1;
  }
  void heart_beat(){
    object owner,env;
    int i,xx,yy;
    env= ETO;
    if(!objectp(ETO))return ;
    if(objectp(env) && living (env)){
      owner=env;
      env=environment(owner);
    }
    if((!(TO->query_worn())) || (ETO->query_invis())){
      return;
    } else {
      xx=random(500);
    yy=random(6)+1;
    if((xx>495)){
       tell_object(owner,"\n%^CYAN%^The robes flap as the winds contained try to escape.\n");
    if(yy==1){
  tell_room(env,"%^CYAN%^"+owner->query_cap_name()+"s robe billows about "+ETO->query_objective()+" in a storm only it can feel.",owner);
	}
    if(yy==2){
      tell_room(env,"%^BOLD%^%^YELLOW%^Lightning crackles %^BLACK%^along the black chains that encircle "+owner->query_cap_name()+"s robes.",owner);
    }
      if(yy==3){tell_room(env,"%^BOLD%^%^CYAN%^Water drips on the floor and pools around "+owner->query_cap_name()+"'s feet.",owner);}
      if(yy==4){tell_room(env,"%^BLUE%^"+owner->query_cap_name()+" is suddenly a backlit shadow as %^BOLD%^%^YELLOW%^lightning%^RESET%^%^BLUE%^ crashes behind "+owner->query_objective()+"!",owner);}
      if(yy==5){tell_room(env,"%^CYAN%^As a gust of wind passes through the room "+owner->query_cap_name()+"'s robes suddenly stop flapping and remains calm till the wind passes!",owner);}
    if(yy==6){tell_room(env,"%^BOLD%^BLACK%^Thunder rolls through the room shaking everyone!",owner);}
      if(yy==7){tell_room(env,"%^CYAN%^Winds whips at "+owner->query_cap_name()+"'s robe and the tatters seem held together only by the blackened chains that hang around them!",owner);}
      }
    return;
  }
  }

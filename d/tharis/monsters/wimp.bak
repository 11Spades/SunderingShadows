//wimp.c

#include <std.h>

inherit "/d/tharis/monsters/wfwander";

string current;

void make_me();
void new_form();
void make_imp();

void create(){
	::create();
	set_name("imp");
	set_id(({"imp","rat","spider","Imp"}));
	set_hd(4,8);
	set_hp(40);
	add_money("gold",random(50));
	add_money("copper",random(35));
	set_attacks_num(1);
	make_me();
	set_gender("male");
	set_exp(1500);
	set_alignment(3);
}

void make_me(){
	set_long(
@OLI
	This heinous little creature has vaguely human form. It has thick,
leathery skin covering it's body. Two small wings prtrude from it's back.
It seems that this monster has been summoned from the depths of some 
horrible dream.
OLI
	);
	set_short("A leathery little imp");
	set_attack_limbs(({"tail"}));
	set_body_type("human");
	add_limb("tail","torso",0,0,0);
	add_limb("left wing","torso",0,0,0);
	add_limb("right wing","torso",0,0,0);
	set_damage(1,6);
	set_hit_funcs((["tail":(:TO,"poison_me":)]));
	set_race("imp");
	set_base_damage_type("piercing");
	set_overall_ac(0);
}

int poison_me(object targ){
	if(random(100) < 5){
		tell_object(targ,"%^BOLD%^%^RED%^The poison reaches your heart and you feel it slow to stopping.\n");
		tell_object(targ,"%^BOLD%^%^RED%^Your lungs seem to be colapsing there is no more air in the world.\n");
		tell_object(targ,"%^BOLD%^%^RED%^Your brain slow shuts down! You slip from conciousness..........and life!");
		return 10000;
	} else {
		tell_object(targ,"%^BOLD%^%^CYAN%^You feel your body fighting off the poison flowing through it!\n");
		tell_object(targ,"%^BOLD%^%^CYAN%^You feel you will live!");
		return 0;
	}
}

void heart_beat(){
	::heart_beat();
	
	if(!objectp(TO)) return;
	if(query_race() == "imp" && query_attackers() == ({}))
		new_form();
	if(query_race() != "imp" && query_attackers() != ({}))
		make_imp();
	
	if(query_hp() < 10){
		run_away();
		set_invis();
	}
}

void new_form(){
	int num;
	int my_hp;
	object ob;
	
	num = random(2);
	seteuid(getuid());
	if(num){
		ob = new("/d/tharis/monsters/grat");
		ob->set_hp(TO->query_hp());
		ob->set_attackers(query_attackers());
           ob->move(ETO);
	}else{
	    ob = new("/d/tharis/monsters/gspider");
		ob->set_hp(TO->query_hp());
		ob->move(ETO);
		ob->set_attackers(query_attackers());
	}
	
		
	tell_room(ETO,"%^BOLD%^%^YELLOW%^You witness a wonderous transformation as this creature changes form!");
	remove();
}
	
void make_imp(){
	object ob;
	ob = new("/d/tharis/monsters/imp");
	ob->set_hp(TO->query_hp());
	ob->move(ETO);
	ob->set_attackers(query_attackers());
	tell_room(ETO,"%^BOLD%^%^YELLOW%^You witness a wonderous transformation as this creature reveals it's true form!");
	remove();

}



void init(){
	::init();
	
	if(ALIGN->is_good(TP) && !TP->query_invis())
		kill_ob(TP,1);
}

int kill_ob(object victim, int which){
	object *inven;
	int i,k;
	if(!swarm){
  	if(victim == TP && interactive(TP)){

           swarm = 1;
                inven = all_inventory(environment(TO));
                k = sizeof(inven);
                for(i=0;i<k;i++){
                        if(living(inven[i])){
                            if(ALIGN->is_evil(inven[i])){
                            	 if(inven[i] != TP)
                                 inven[i]->kill_ob(TP,1);
                             }
                        }
                }
        }
        swarm = 0;
     }
	return ::kill_ob(victim,which);
}

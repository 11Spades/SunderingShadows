//adapted from Nienne's portals for use with the psion planar enclave
//~Circe~ 10/20/07
#include <std.h>
#include <daemons.h>
inherit ROOM;

int do_portal(string location, object player);

void create(){
    ::create();
    set_property("indoors",0);
    set_property("light",2);
    set_travel(PAVED_ROAD);
    set_terrain(CITY);
    set_name("An open-air foyer");
    set_short("%^RESET%^%^MAGENTA%^An open-air foyer%^RESET%^");
    set_long("%^RESET%^%^MAGENTA%^An open-air foyer%^RESET%^\n"+
       "The %^CYAN%^wind %^RESET%^blows gently, switching directions "+
       "continually in this unusual open-air foyer.  The sky above "+
       "reveals that this is no ordinary place, as it is %^BOLD%^%^BLACK%^"+
       "deep black %^RESET%^streaked with %^GREEN%^greens%^RESET%^, "+
       "%^CYAN%^blues%^RESET%^, %^MAGENTA%^purples%^RESET%^, and "+
       "brilliant spots of %^YELLOW%^gold%^RESET%^.  The foyer seems "+
       "to have been grown here rather than built, though it is shaped "+
       "something like the classic buildings of the realms.  Rising "+
       "from the %^MAGENTA%^cr%^BOLD%^y%^RESET%^%^MAGENTA%^stalli%^BOLD%^n"+
       "%^RESET%^%^MAGENTA%^e ground %^RESET%^is a ring of smooth "+
       "translucent %^MAGENTA%^pillars %^RESET%^that shift in color from "+
       "%^MAGENTA%^deep purple %^RESET%^to a %^BOLD%^%^MAGENTA%^light "+
       "blush %^RESET%^and end in jagged crowns, almost as if they still "+
       "bear the ghost of a roof.  %^BOLD%^%^CYAN%^Flashes %^RESET%^of "+
       "%^BOLD%^sil%^CYAN%^v%^WHITE%^ery li%^CYAN%^g%^WHITE%^ht %^RESET%^"+
       "illuminate the ring of columns and reveal a %^BOLD%^circle "+
       "%^RESET%^carved into the crystal of the ground.  An "+
       "%^CYAN%^ethereal building %^RESET%^carved from shimmering "+
       "crystal walls rises to the east.\n\n"+
       "A sign has been carved into one of the pillars.\n");
    set_listen("default","The low moan of the wind breaks the silence.");
    set_smell("default","A light fragrance of ozone resides in the air here.");
    set_items(([
      ({"circle","dust","glittering dust"}) : "%^BOLD%^%^BLUE%^A circle has "
         "been carved into the %^RESET%^%^MAGENTA%^smooth crystalline ground"+
         "%^BOLD%^%^BLUE%^, and filled with some kind of %^RESET%^gli%^BOLD%^"+
         "t%^RESET%^ter%^BOLD%^i%^RESET%^ng %^BOLD%^%^BLUE%^dust, perhaps to "+
         "highlight its presence.",
      ({"sky","colors","streaks","light","flashes","lights"}) : "%^BOLD%^%^BLACK%^The "+
         "inky black sky is lightened in places "+
         "with streaks and swirls of %^GREEN%^greens%^BLACK%^, "+
         "%^CYAN%^blues%^BLACK%^, %^RESET%^%^MAGENTA%^purples%^BOLD%^"+
         "%^BLACK%^, and %^YELLOW%^golds%^BLACK%^.  Flashes of light "+
         "reminiscent of lightning without the thunder brighten the sky "+
         "in fitful intervals.%^RESET%^",
      ({"pillars","columns","pillar","column"}):"%^RESET%^%^MAGENTA%^"+
         "Encircling the smooth crystalline floor is a ring of "+
         "pillars made of pur%^BOLD%^p%^RESET%^%^MAGENTA%^le crystal.  "+
         "Each column ends in a jagged top, almost as if some force "+
         "ripped a roof away at one time.  Carved into one of the "+
         "pillars is a %^RESET%^sign %^MAGENTA%^you could read.%^RESET%^",
      "sign":({"%^BOLD%^%^MAGENTA%^A small %^RESET%^sign "+
         "%^BOLD%^%^MAGENTA%^has carved into the pillar, engraved with "+
         "elegant script you could read.%^RESET%^","%^YELLOW%^"+
         "The words on the sign seem to shift and change into legible "+
         "characters as you look at them.%^RESET%^\n\nYou "+
         "may %^YELLOW%^buy portal to%^RESET%^ a city from here: "+
         "%^YELLOW%^Torm%^RESET%^, %^YELLOW%^Azha%^RESET%^, "+
         "%^YELLOW%^Verbobone%^RESET%^, %^YELLOW%^Shadow%^RESET%^, "+
         "or %^YELLOW%^Seneca%^RESET%^.  "+
         "Simply %^YELLOW%^ask the price of%^RESET%^ a "+
         "portal to any of these cities, to find out what it "+
         "would cost to travel there.","wizish"}),
      "building" : "Looming on the east is a fanciful building with "+
         "arching lines and curves.  Like the pillars, it seems almost "+
         "organic, grown from crystals of varying colors."
    ]));
    set_exits(([
      "east":"/d/shadow/room/city/portal/fountain"
    ]));
}

query_weather() { return "%^BOLD%^%^BLUE%^The constant wind swirls "+
   "through the %^GREEN%^co%^CYAN%^lo%^RESET%^%^MAGENTA%^r-%^YELLOW%^st"+
   "%^GREEN%^re%^CYAN%^ak%^RESET%^%^MAGENTA%^ed %^BOLD%^%^BLUE%^sky%^RESET%^."; }

void reset(){
    if(!present("nomad")) {
      new("/d/shadow/mon/nomad")->move(TO);
      tell_room(TO,"%^CYAN%^A robed human enters quietly into the area, to "
         "stand behind the etched circle.%^RESET%^");
    }
}

void init(){
    ::init();
    add_action("get_portal","buy");
    add_action("get_price","ask");
}

int get_price(string str) {
    int mylevel;
    string location;
    object mynomad;
    if(!present("nomad"))
      return notify_fail("There's noone here for you to buy from.\n");
    if(TP->query_bound() || TP->query_unconscious() || TP->query_gagged()) {
      TP->send_paralyzed_message("info",TP);
      return 1;
    }
    if(TP->query_blind()) {
      tell_object(TP,"You can't even see who to ask!");
      return 1;
    }
    if(TP->query_invis() && !avatarp(TP)) {
      tell_object(TP,"They can't even see you!");
      return 1;
    }
    mynomad = present("nomad");
    if(sizeof(mynomad->query_attackers()) > 0) {
      tell_object(TP,"The nomad is too distracted right now.");
      return 1;
    }
    if(sizeof(TP->query_attackers()) > 0) {
      tell_object(TP,"You are too distracted right now.");
      return 1;
    }
    if (!str) {
      tell_object(TP,"You need to ask for a location.");
      return 1;
    }
    if ((sscanf(str,"the price of %s",location) != 1)) {
      tell_object(TP,"You need to ask for a location.");
      return 1;
    }
    if(location != "torm" && location != "Torm" && location != "seneca" && location != "Seneca" && location != "verbobone" && location != "Verbobone" && location != "azha" && location != "Azha" && location != "shadow" && location != "Shadow") {
      tell_object(TP,"That's not a valid location!");
      return 1;
    }
    mylevel = TP->query_highest_level();
    if(avatarp(TP)) {
      tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ You lucky imm, it won't cost you anything.");
      return 1;
    }
    switch(location) {
      case "torm": case "Torm":
      case "azha": case "Azha":
      case "shadow": case "Shadow":
      switch(mylevel) {
        case 1..14:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ I'm afraid you're too young yet to travel to "+location+".");
        return 1;
        break;
        case 15..24:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ It will cost you 500 gold to travel to "+location+".");
        return 1;
        break;
        case 25..34:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ It will cost you 1000 gold to travel to "+location+".");
        return 1;
        break;
        case 35..44:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ It will cost you 1500 gold to travel to "+location+".");
        return 1;
        break;
        case 45..60:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ It will cost you 2000 gold to travel to "+location+".");
        return 1;
        break;
        default:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ I'm afraid you've broken something, please contact a wiz.");
        return 1;
        break;
      }
      break;

      case "verbobone": case "Verbobone":
      switch(mylevel) {
        case 1..14:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ I'm afraid you're too young yet to travel to "+location+".");
        return 1;
        break;
        case 15..24:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ It will cost you 1000 gold to travel to "+location+".");
        return 1;
        break;
        case 25..34:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ It will cost you 1500 gold to travel to "+location+".");
        return 1;
        break;
        case 35..44:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ It will cost you 2000 gold to travel to "+location+".");
        return 1;
        break;
        case 45..60:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ It will cost you 2500 gold to travel to "+location+".");
        return 1;
        break;
        default:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ I'm afraid you've broken something, please contact a wiz.");
        return 1;
        break;
      }
      break;

      case "seneca": case "Seneca":
      switch(mylevel) {
        case 1..24:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ I'm afraid you're too young yet to travel to "+location+".");
        return 1;
        break;
        case 25..34:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ It will cost you 2000 gold to travel to "+location+".");
        return 1;
        break;
        case 35..44:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ It will cost you 2500 gold to travel to "+location+".");
        return 1;
        break;
        case 45..60:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ It will cost you 3000 gold to travel to "+location+".");
        return 1;
        break;
        default:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ I'm afraid you've broken something, please contact a wiz.");
        return 1;
        break;
      }
      break;
    }
    tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ I'm afraid you've broken something, please contact a wiz.");
    return 1;
}

int get_portal(string str) {
    int mylevel, myprice;
    string location;
    object mynomad;
    if(!present("nomad"))
      return notify_fail("There's noone here for you to buy from.\n");
    if(TP->query_bound() || TP->query_unconscious() || TP->query_gagged()) {
      TP->send_paralyzed_message("info",TP);
      return 1;
    }
    if(TP->query_blind()) {
      tell_object(TP,"You can't even see who to ask!");
      return 1;
    }
    if(TP->query_invis() && !avatarp(TP)) {
      tell_object(TP,"They can't even see you!");
      return 1;
    }
    mynomad = present("nomad");
    if(sizeof(mynomad->query_attackers()) > 0) {
      tell_object(TP,"The nomad is too distracted right now.");
      return 1;
    }
    if(sizeof(TP->query_attackers()) > 0) {
      tell_object(TP,"You are too distracted right now.");
      return 1;
    }
    if (!str) {
      tell_object(TP,"You need to ask for a location.");
      return 1;
    }
    if ((sscanf(str,"portal to %s",location) != 1)) {
      tell_object(TP,"You need to ask for a location.");
      return 1;
    }
    if(location != "torm" && location != "Torm" && location != "seneca" && location != "Seneca" && location != "verbobone" && location != "Verbobone" && location != "azha" && location != "Azha" && location != "shadow" && location != "Shadow") {
      tell_object(TP,"That's not a valid location!");
      return 1;
    }
    mylevel = TP->query_highest_level();
    if(avatarp(TP)) {
      tell_room(TO,"%^CYAN%^The nomad makes a motion to the circle, and the "
         "crystalline pillars begin to %^WHITE%^glow%^CYAN%^ softly.%^RESET%^");
      call_out("do_portal",5,location,TP);
      return 1;
    }
    switch(location) {
      case "torm": case "Torm":
      case "azha": case "Azha":
      case "shadow": case "Shadow":
      switch(mylevel) {
        case 1..14: tell_object(TP,"%^CYAN%^The psion's voice reaches your "
"mind:%^RESET%^ I'm afraid you're too young yet to travel to "+location+".");
        return 1; break;
        case 15..24: myprice = 500; break;
        case 25..34: myprice = 1000; break;
        case 35..44: myprice = 1500; break;
        case 45..60: myprice = 2000; break;
        default:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ I'm afraid you've broken something, please contact a wiz.");
        return 1;
        break;
      }
      break;

      case "verbobone": case "Verbobone":
      switch(mylevel) {
        case 1..14: tell_object(TP,"%^CYAN%^The psion's voice reaches your "
"mind:%^RESET%^ I'm afraid you're too young yet to travel to "+location+".");
        return 1; break;
        case 15..24: myprice = 1000; break;
        case 25..34: myprice = 1500; break;
        case 35..44: myprice = 2000; break;
        case 45..60: myprice = 2500; break;
        default:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ I'm afraid you've broken something, please contact a wiz.");
        return 1;
        break;
      }
      break;

      case "seneca": case "Seneca":
      switch(mylevel) {
        case 1..24: tell_object(TP,"%^CYAN%^The psion's voice reaches your "
"mind:%^RESET%^ I'm afraid you're too young yet to travel to "+location+".");
        return 1; break;
        case 25..34: myprice = 2000; break;
        case 35..44: myprice = 2500; break;
        case 45..60: myprice = 3000; break;
        default:
        tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ I'm afraid you've broken something, please contact a wiz.");
        return 1;
        break;
      }
      break;
    }
    if(!(int)TP->query_funds("gold",myprice)) {
      tell_object(TP,"%^CYAN%^The psion's voice reaches your mind:"
"%^RESET%^ I'm afraid you don't have enough money. You will need "+myprice+
" gold to travel to "+location+".");
      return 1;
    }
    TP->use_funds("gold",myprice);
    tell_room(TO,"%^CYAN%^The nomad makes a motion to the circle, and the "
"crystalline pillars begin to %^WHITE%^glow %^CYAN%^softly.%^RESET%^");
    call_out("do_portal",5,location,TP);
    return 1;
}

int do_portal(string location, object player) {
    string mylocation;
    object mylocation2, mynomad;
    if(!objectp(TO)) return 1;
    if(!present("nomad")) {
      tell_room(TO,"%^CYAN%^The spell fails without its caster "
"present.%^RESET%^");
      return 1;
    }
    if(!objectp(player) || !present(player)) {
      tell_room(TO,"%^CYAN%^The nomad steps back again, as the spell fails "
"without its focus present.%^RESET%^");
      return 1;
    }
    mynomad = present("nomad");
    if(sizeof(mynomad->query_attackers()) > 0) {
      tell_room(TO,"%^CYAN%^The spell fails, with its caster too distracted "
"to maintain it.%^RESET%^");
      return 1;
    }
    if(sizeof(TP->query_attackers()) > 0) {
      tell_room(TO,"%^CYAN%^The spell fails, with its subject too disturbed "
"to maintain it.%^RESET%^");
      return 1;
    }
    switch(location) {
      case "torm": case "Torm":
      mylocation = "/d/dagger/Torm/road/path12"; break;
      case "azha": case "Azha":
      mylocation = "/d/azha/town/wroad"; break;
      case "shadow": case "Shadow":
      mylocation = "/d/shadow/room/city/psion2"; break;
      case "verbobone": case "Verbobone":
      mylocation = "/d/deku/town/road13"; break;
      case "seneca": case "Seneca":
      mylocation = "/d/attaya/seneca/boardwalk3"; break;
    }
    mylocation2 = find_object_or_load(mylocation);
    tell_room(TO,"%^CYAN%^A sudden %^BOLD%^%^WHITE%^flash%^RESET%^%^CYAN%^ of "
"light encloses the circle, and "+player->QCN+" is no longer "
"there!%^RESET%^",player);
    tell_object(player,"%^CYAN%^A sudden %^BOLD%^%^WHITE%^flash%^RESET%^ %^CYAN%^lights up your vision, and you find yourself elsewhere!%^RESET%^");
    tell_room(mylocation2,"%^CYAN%^A sudden pulse of %^BOLD%^%^WHITE%^light "
"%^RESET%^%^CYAN%^appears before you, leaving behind the form of "
+player->QCN+"!%^RESET%^",player);
    player->move_player(mylocation2);
    return 1;
}

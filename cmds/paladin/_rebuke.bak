//
//      _rebuke.c - Paladin Ability that
//      does some damage and can paralyze
//      Grazzt@Shadowwgate June 1996.
//
#include <std.h>
inherit DAEMON;
 
int cmd_rebuke(string str) {
    object tp, ob;
    int dam, wis, hiswis, level, hislevel, failure;
 
    tp = this_player();
    if(!TP->is_class("paladin")){
	notify_fail("This is not for you!\n");
	return 0;
    }
    if(tp->query_ghost()) {
        notify_fail("You need to be alive to rebuke anything!\n");
        return 0;
    }
    if(environment(tp)->query_property("no attack")) {
        notify_fail("You cannot attack in this place.\n");
        return 0;
    }
    if(tp->query_paralyzed() || tp->query_disable()) return 0;
    if((int)tp->query_hp() < 40) {
        notify_fail("You are too weak of health to attempt a "
	"rebuke!\n");
        return 0;
    }
    if(!str) {
        ob = (object)tp->query_current_attacker();
        if(!ob) {
            notify_fail("Rebuke who?\n");
            return 0;
        }
    }
    else {
        ob = present(str, environment(tp));
          if(!ob) {
            notify_fail("No "+str+" here!\n");
            return 0;
          }
        }
    if(!living(ob)) {
        notify_fail(ob->query_cap_name()+" is not a living thing!\n");
        return 0;
    }
    if(ob == tp) {
        notify_fail("Rebuke yourself?\n");
        return 0;
    }
    if(ob->query_ghost()) {
      notify_fail("Rebuke a ghost???\n");
      return 0;
    }
    if(ob->is_player() && !interactive(ob)) {
        notify_fail("You cannot attack link-dead players.\n");
        return 0;
    }
    if((int)tp->query_level() < 6) {
	notify_fail("The Gods refuse your request!\n");
	return 0;
    }
    if((int)TP->query_money("gold") < 50 ) {
        notify_fail("You do not have enough gold to tithe "
		"to pay for the rebuking!\n");
        return 0;
    }
    if(!ob->kill_ob(tp, 0)) return 1;
    level = (int)tp->query_level();
    if (level > 30) level = 30;
    wis = (int)tp->query_stats("wisdom");
    hiswis = (int)ob->query_stats("wisdom");
    hislevel = (int)ob->query_level();
    tp->set_paralyzed(8,"You are busy rebuking!");
    if((int)ob->query_alignment() != 3 &&
      (int)ob->query_alignment() != 6 &&
      (int)ob->query_alignment() != 9) {
	write("There is no evil in this creatures soul!\n"
	+ob->query_cap_name()+
	" is displeased with your accusation!");
	return 1;
    }
    if(level < hislevel) {
	failure = (hislevel - level)*5;
    } else {
	failure = 5;
    }
    if((random(100)+1) < failure) {
        write(
	    "%^YELLOW%^Your rebuke attempt fails to affect "
            +ob->query_cap_name()+"!%^RESET%^"
	);
        message("other_action",
	    "%^BOLD%^%^YELLOW%^"+tp->query_cap_name()+" just "
            "tried to rebuke you!%^RESET%^"
	,ob);
        say(
	    "%^YELLOW%^"+TPQCN+" fails in a rebuke attempt.%^RESET%^"
	,TP);
        tp->add_hp(-(random(2)+2) );
        tp->add_money("gold",(-(30)) );
        return 1;
    }
    message("info", "%^BOLD%^%^YELLOW%^"
	"You rebuke the evil that resides within "
        +(string)ob->query_cap_name()+"'s soul!%^RESET%^"
        "\n%^RED%^You sense evil and will follow this "
	"abomination until it dies!%^RESET%^"
    ,tp);
    message("env", "%^BOLD%^%^YELLOW%^"
	+tp->query_cap_name()+" rebukes "
        "the evil within "
	+(string)ob->query_cap_name()+"'s soul!"
	"%^RED%^\n"+ob->query_cap_name()+
        " falls vomiting to the ground!%^RESET%^"
    ,environment(tp), ({ ob, tp }));
    message("target", "%^YELLOW%^%^BOLD%^"
	+(string)tp->query_cap_name()+
        " rebukes the evil within your soul!"
	"%^RED%^\nYou fall to the ground writhing in pain and vomiting "
	"excessively!%^RESET%^"
    ,ob);
    ob->add_follower(TP);
    dam = (random(level) + (level/2) + random(wis) + 
	(wis/2)+4) - (random(hiswis)); 
    if(random(wis) > random(hiswis/3)) {
        ob->set_paralyzed(random(wis)+random(level)+10, 
	    "%^BOLD%^%^YELLOW%^"
	    "You are vomiting and cannot move.");
    } else {
	write(
	    "%^YELLOW%^%^BOLD%^Your foe quickly recovers.%^RESET%^"
	);
    }  
    ob->do_damage("head",dam);
    tp->add_hp(-(random(3)+2));
    tp->add_money("gold",(-(50)) );
    return 1;
}
 
void help() {
    message("my_action", 
	"Syntax: <rebuke [(living)]>\n"
        "A Paladin who has properly proven faith to the Gods "
        "can attempt to rebuke the evil within their victims "
        "causing the victim to possibly lose itself for a period "
	"in vomiting "
        "paralyzation as well as inflicting damage to the victim."
	"Note: This ability requires a tithe of gold and will drain "
	"the Paladin of a minor bit of health when used." 
    ,this_player());
}

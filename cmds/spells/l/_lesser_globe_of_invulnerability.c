#include <spell.h>
#include <daemons.h>
#include <magic.h>
inherit SPELL;

int query_inv_power()
{
    return 3;
}

void create() 
{
    ::create();
    set_spell_name("lesser globe of invulnerability");
    set_spell_level(([ "mage" : 4 ]));
    set_spell_sphere("abjuration");
    set_syntax("cast CLASS lesser globe of invulnerability");
    set_description("With this spell, you surround yourself with anti-magic field that disrupts intrinsic connections in the weave, briefly preventing spells of level 3 or less from entering the globe around you. This spell affects only targeted spells.");
    set_verbal_comp();
    set_somatic_comp();
    set_helpful_spell(1);
    set_components(([
      "mage" : ([ "small diamond" : 1, ]),
    ]));    
}

int preSpell()
{
   if((int)CASTER->query_property("spell invulnerability"))
   {
      tell_object(CASTER,"You are already under the influence of similar effect.");
      return 0;
   }
   return 1;
}

void spell_effect()
{
    int duration;
    tell_object(caster, "%^WHITE%^%^BOLD%^The air around you starts to shimmer, as intrinsic magic field is disrupted by your will!%^RESET%^");
    tell_room(place,"%^WHITE%^%^BOLD%^"+caster->QCN+" is suddenly surrounded by globe of shimmer!%^RESET%^",caster);
    spell_successful();
    addSpellToCaster();
    duration = clevel/7+1;
    caster->set_property("spell invulnerability",query_inv_power());
    call_out("dest_effect",duration*ROUND_LENGTH);
}

void dest_effect(){
     if(objectp(caster))
     {
      tell_object(caster,"%^BLUE%^The glove of force surrounding you fades.%^RESET%^");
      tell_room(environment(caster),"%^BLUE%^The globe surrounding "+caster->QCN+" fades.%^RESET%^",caster);
      caster->remove_property("spell invulnerability");
    }
    ::dest_effect();
    if(objectp(TO))
        TO->remove();
}


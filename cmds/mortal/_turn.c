#include <std.h>

#define SAVEROLLS ({ \
  ({ 10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2,-2 }), \
  ({ 99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,20,19,16,13,10,7,4,-1,-1,-2,-2,-2,-2,-2,-2 }), \
}) 
inherit DAEMON;
string last_user,last_room;

int cmd_turn(string str){
  object *ob;
  int inc,hd,lvl,roll,myroll,clvl,plvl,alvl;

  if(!str) 
    return notify_fail("Turn what?\n");                            

   if (TP->query_bound() || TP->query_tripped()) {
      TP->send_paralyzed_message("info",TP);
      return 1;
   }
// adding this check here and invis. below based on bug reports *Styx* 8/20/03
   if(!present("holy symbol", TP))
      return notify_fail("You need a holy symbol to turn undead.\n");


  if(str != "undead") 
    return notify_fail("You can't turn that!\n");
   if(!TP->is_class("cleric") && !TP->is_class("paladin") && !TP->is_class("antipaladin"))
//    return notify_fail("Only clerics, paladins, and antipaladins can turn undead.\n");
    return notify_fail("Only clerics and paladins can turn undead.\n");
  if((last_user) && (last_user == (string)TP->query_name()))
    if((last_room) && (last_room == file_name(ETP)))
      return notify_fail("You have already tried!\n");
// adding this check for invis. and putting it down here so it's not as readily able to be used to find out if they are hidden/invis.  *Styx* 8/20/03
  if(TP->query_invis())
      return notify_fail("The undead don't seem to notice your attempt.\n");
  last_user = (string)TPQN;
  last_room = file_name(ETP);
/*  ob = all_inventory(ETP);   
    changing to all_living so it won't try to query race on non livings, etc.  
    *Styx* 11/5/03, last change 8/20/03
*/
  ob = all_living(ETP);
  if(TP->is_class("cleric")){ clvl = TP->query_class_level("cleric"); }
  if(TP->is_class("paladin")){ plvl = TP->query_class_level("paladin"); }
  if(TP->is_class("antipaladin")){ alvl = TP->query_class_level("antipaladin"); }
  lvl = 0;
  lvl += clvl + plvl + alvl;
  if(lvl == 11) lvl = 10;
  if((lvl == 12) || (lvl == 13)) lvl = 11;
  if(lvl >=14) lvl = lvl - 2;
  if(lvl > 39) lvl = 39;
  lvl--;
  if(TP->is_class("paladin")) lvl -= 2;
  if(lvl < 0) lvl = 0;
  myroll = random(20) + 1;
  for(inc = 0;inc < sizeof(ob);inc ++) {
    if(!objectp(ob[inc]))    continue;   // added this objectp check too *Styx* 11/5/03
    if(interactive(ob[inc])) continue;                                  
    if((int)ob[inc]->query_property("no death") == 1 || (int)ob[inc]->query_property("no kill") == 1) continue;
    if((int)ob[inc]->query_property("undead") == 1 ||(string)ob[inc]->query_race() == "undead") {
      hd = (int)ob[inc]->query_hd()-1; 
      if(hd>29) hd=29;
      roll = SAVEROLLS[hd][lvl];
      tell_object(TP, "You raise your holy symbol at the undead.");
      tell_room(ETP, TPQCN+" raises "+TP->query_possessive()+" holy symbol at the undead.", TP);
      if(roll == 99) write("You cannot turn this one.\n");
      else if(roll == -2){
//           write("You killed one!");  added room message *Styx*  11/13/02
	   tell_room(ETP,capitalize(ob[inc]->query_name())+" keels over in front of you.");
           ob[inc]->die();
      }
      else if((roll == -1) || (myroll >= roll)) {
	   tell_room(ETP,capitalize(ob[inc]->query_name())+" disintegrates into dust.");
	   write("You turned "+ob[inc]->query_name()+" and it disintegrates into dust!");
           ob[inc]->move("/d/shadowgate/void");
           ob[inc]->remove();
      }
   }
        
  }
  return 1;
}
